{%- liquid
  assign color_scheme = 'color-' | append: section.settings.color_scheme
  assign image = section.settings.image
  assign dot_color = section.settings.dot_color
  assign line_color = section.settings.line_color

  assign blocks = section.blocks
  assign block_count = 0
  for b in blocks
    if b.settings.title != blank or b.settings.text != blank
      assign block_count = block_count | plus: 1
    endif
  endfor
-%}

<section
  id="TimelineStatic--{{ section.id }}"
  class="timeline-static section-padding {{ color_scheme }}"
  style="
    --PT: {{ section.settings.padding_top }}px;
    --PB: {{ section.settings.padding_bottom }}px;
    --dot: {{ dot_color }};
    --line: {{ line_color }};
  "
  data-section-id="{{ section.id }}"
>
  <div class="wrapper--full-padded">
    <div class="timeline-static__grid">
      <!-- LEFT: Timeline -->
      <div class="timeline-static__timeline">
        {%- if section.settings.title != blank -%}
          <h2 class="hero__title {{ section.settings.heading_font_size }}">{{ section.settings.title | escape }}</h2>
        {%- endif -%}

        {%- if section.settings.text != blank -%}
          <div class="hero__rte {{ section.settings.text_font_size }}">{{ section.settings.text }}</div>
        {%- endif -%}

        <!-- Desktop list -->
        <ol class="timeline-static__list" aria-label="Timeline">
          {%- assign i = 0 -%}
          {%- for block in section.blocks -%}
            {%- if block.settings.title != blank or block.settings.text != blank -%}
              {%- assign i = i | plus: 1 -%}
              <li class="timeline-static__item" {{ block.shopify_attributes }}>
                <div class="timeline-static__rail" aria-hidden="true">
                  <span class="timeline-static__dot"></span>
                </div>

                <div class="timeline-static__content">
                  {%- if block.settings.title != blank -%}
                    <h3 class="hero__title {{ block.settings.heading_font_size | default: 'heading-small' }}">
                      {{ block.settings.title | escape }}
                    </h3>
                  {%- endif -%}

                  {%- if block.settings.text != blank -%}
                    <div class="hero__rte {{ block.settings.text_font_size | default: 'body-medium' }}">
                      {{ block.settings.text }}
                    </div>
                  {%- endif -%}
                </div>
              </li>
            {%- endif -%}
          {%- endfor -%}
        </ol>

        <!-- Mobile swiper -->
        <div class="timeline-static__mobile" data-timeline-mobile>
          <div class="timeline-static__track" data-track aria-label="Timeline slides">
            {%- assign s = 0 -%}
            {%- for block in section.blocks -%}
              {%- if block.settings.title != blank or block.settings.text != blank -%}
                {%- assign s = s | plus: 1 -%}
                <article class="timeline-static__slide" data-slide data-index="{{ s }}">
                  <div class="timeline-static__slide-rail" aria-hidden="true">
                    <span class="timeline-static__dot"></span>
                    <span class="timeline-static__mini-line"></span>
                  </div>

                  <div class="timeline-static__slide-content">
                    {%- if block.settings.title != blank -%}
                      <h3 class="hero__title {{ block.settings.heading_font_size | default: 'heading-small' }}">
                        {{ block.settings.title | escape }}
                      </h3>
                    {%- endif -%}

                    {%- if block.settings.text != blank -%}
                      <div class="hero__rte {{ block.settings.text_font_size | default: 'body-medium' }}">
                        {{ block.settings.text }}
                      </div>
                    {%- endif -%}
                  </div>
                </article>
              {%- endif -%}
            {%- endfor -%}
          </div>

          {%- if block_count > 1 -%}
            <div class="timeline-static__pagination" data-pagination aria-label="Timeline pagination">
              {%- for n in (1..block_count) -%}
                <button
                  type="button"
                  class="timeline-static__pager{% if forloop.first %} is-active{% endif %}"
                  data-pager
                  data-go="{{ n }}"
                  aria-label="Go to slide {{ n }}"
                >
                  <span class="timeline-static__pager-dot" aria-hidden="true"></span>
                </button>
              {%- endfor -%}
            </div>
          {%- endif -%}
        </div>
      </div>

      <!-- RIGHT: Image (50vw) -->
      <div class="timeline-static__image">
        {%- if image != blank -%}
          {%- render 'image',
            image: image,
            sizes: '50vw, 100vw',
            widths: '750, 1100, 1600, 2200, 2800',
            modifier: 'timeline-static__image-figure',
            cover: true
          -%}
        {%- else -%}
          <div class="timeline-static__image-placeholder" aria-hidden="true"></div>
        {%- endif -%}
      </div>
    </div>
  </div>

  {%- style -%}
    #TimelineStatic--{{ section.id }} {
      padding-top: var(--PT);
      padding-bottom: var(--PB);
    }

    /* Layout: static desktop, image fixed to 50vw */
    #TimelineStatic--{{ section.id }} .timeline-static__grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 50vw;
      gap: 48px;
      align-items: start;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__timeline {
      max-width: 720px;
    }

    /* Desktop timeline list */
    #TimelineStatic--{{ section.id }} .timeline-static__list {
      margin: 28px 0 0;
      padding: 0;
      list-style: none;
      position: relative;
    }

    /* The main vertical line (auto extends with content height) */
    #TimelineStatic--{{ section.id }} .timeline-static__list::before {
      content: "";
      position: absolute;
      left: 10px;
      top: 8px;
      bottom: 8px;
      width: 1px;
      background: var(--line);
      opacity: 1;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__item {
      display: grid;
      grid-template-columns: 24px minmax(0, 1fr);
      gap: 18px;
      padding: 18px 0;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__rail {
      position: relative;
      display: flex;
      justify-content: center;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: var(--dot);
      display: block;
      margin-top: 4px;
    }

    /* Right image column */
    #TimelineStatic--{{ section.id }} .timeline-static__image {
      position: relative;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__image-figure {
      width: 100%;
      height: 100%;
      min-height: 520px;
      border-radius: 0;
      overflow: hidden;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__image-placeholder {
      width: 100%;
      min-height: 520px;
      background: rgba(0,0,0,0.06);
    }

    /* Mobile: switch to swipe */
    #TimelineStatic--{{ section.id }} .timeline-static__mobile {
      display: none;
      margin-top: 18px;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__track {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 8px;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__track::-webkit-scrollbar {
      height: 0;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__slide {
      scroll-snap-align: start;
      flex: 0 0 88%;
      max-width: 88%;
      display: grid;
      grid-template-columns: 24px minmax(0, 1fr);
      gap: 16px;
      padding: 16px 0;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__slide-rail {
      position: relative;
      display: flex;
      justify-content: center;
      padding-top: 4px;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__mini-line {
      position: absolute;
      left: 50%;
      top: 22px;
      transform: translateX(-50%);
      width: 1px;
      height: calc(100% - 22px);
      background: var(--line);
    }

    #TimelineStatic--{{ section.id }} .timeline-static__pagination {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__pager {
      appearance: none;
      border: 0;
      background: transparent;
      padding: 0;
      width: 24px;
      height: 24px;
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__pager-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--line);
      opacity: 0.35;
    }

    #TimelineStatic--{{ section.id }} .timeline-static__pager.is-active .timeline-static__pager-dot {
      opacity: 1;
      background: var(--dot);
    }

    @media (max-width: 749px) {
      #TimelineStatic--{{ section.id }} .timeline-static__grid {
        grid-template-columns: 1fr;
        gap: 22px;
      }

      /* Image becomes top (or keep it below â€” swap order if you want) */
      #TimelineStatic--{{ section.id }} .timeline-static__image {
        order: -1;
      }

      /* Hide desktop list; show swiper */
      #TimelineStatic--{{ section.id }} .timeline-static__list {
        display: none;
      }
      #TimelineStatic--{{ section.id }} .timeline-static__mobile {
        display: block;
      }

      #TimelineStatic--{{ section.id }} .timeline-static__image-figure,
      #TimelineStatic--{{ section.id }} .timeline-static__image-placeholder {
        min-height: 320px;
      }
    }
  {%- endstyle -%}

  <script>
    (function () {
      var root = document.getElementById('TimelineStatic--{{ section.id }}');
      if (!root) return;

      var mobile = root.querySelector('[data-timeline-mobile]');
      if (!mobile) return;

      var track = mobile.querySelector('[data-track]');
      var pagers = mobile.querySelectorAll('[data-pager]');
      var slides = mobile.querySelectorAll('[data-slide]');
      if (!track || !slides.length) return;

      // Only run on mobile
      var mq = window.matchMedia('(max-width: 749px)');
      if (!mq.matches) return;

      function setActive(index1) {
        pagers.forEach(function(btn){
          btn.classList.toggle('is-active', btn.getAttribute('data-go') === String(index1));
        });
      }

      function scrollToIndex(index1) {
        var slide = mobile.querySelector('[data-slide][data-index="' + index1 + '"]');
        if (!slide) return;
        track.scrollTo({ left: slide.offsetLeft, behavior: 'smooth' });
      }

      pagers.forEach(function(btn){
        btn.addEventListener('click', function(){
          var n = btn.getAttribute('data-go');
          scrollToIndex(n);
          setActive(n);
        });
      });

      // Update active pager on scroll
      var ticking = false;
      track.addEventListener('scroll', function(){
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(function(){
          ticking = false;
          var best = 1;
          var bestDist = Infinity;
          slides.forEach(function(slide){
            var dist = Math.abs(slide.offsetLeft - track.scrollLeft);
            if (dist < bestDist) {
              bestDist = dist;
              best = slide.getAttribute('data-index');
            }
          });
          setActive(best);
        });
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Static timeline",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section heading",
      "default": "Our story"
    },
    {
      "type": "select",
      "id": "heading_font_size",
      "label": "Heading size",
      "default": "heading-large",
      "options": [
        { "value": "heading-mini", "label": "Mini" },
        { "value": "heading-x-small", "label": "Extra small" },
        { "value": "heading-small", "label": "Small" },
        { "value": "heading-medium", "label": "Medium" },
        { "value": "heading-large", "label": "Large" },
        { "value": "heading-x-large", "label": "Extra large" }
      ]
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Intro text",
      "default": "<p>Add your timeline milestones below.</p>"
    },
    {
      "type": "select",
      "id": "text_font_size",
      "label": "Text size",
      "default": "body-medium",
      "options": [
        { "value": "body-x-small", "label": "Extra small" },
        { "value": "body-small", "label": "Small" },
        { "value": "body-medium", "label": "Medium" },
        { "value": "body-large", "label": "Large" },
        { "value": "body-x-large", "label": "Extra large" }
      ]
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Right image",
      "info": "Displays as 50vw on desktop; full width on mobile."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "scheme_1",
      "label": "Color scheme"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot color",
      "default": "#000000",
      "alpha": true
    },
    {
      "type": "color",
      "id": "line_color",
      "label": "Line color",
      "default": "#000000",
      "alpha": true
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Top padding",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Bottom padding",
      "default": 32
    }
  ],
  "max_blocks": 4,
  "blocks": [
    {
      "type": "step",
      "name": "Timeline item",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Milestone"
        },
        {
          "type": "select",
          "id": "heading_font_size",
          "label": "Heading size",
          "default": "heading-small",
          "options": [
            { "value": "heading-mini", "label": "Mini" },
            { "value": "heading-x-small", "label": "Extra small" },
            { "value": "heading-small", "label": "Small" },
            { "value": "heading-medium", "label": "Medium" },
            { "value": "heading-large", "label": "Large" },
            { "value": "heading-x-large", "label": "Extra large" }
          ]
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Body copy",
          "default": "<p>Add a short description here.</p>"
        },
        {
          "type": "select",
          "id": "text_font_size",
          "label": "Text size",
          "default": "body-medium",
          "options": [
            { "value": "body-x-small", "label": "Extra small" },
            { "value": "body-small", "label": "Small" },
            { "value": "body-medium", "label": "Medium" },
            { "value": "body-large", "label": "Large" },
            { "value": "body-x-large", "label": "Extra large" }
          ]
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Static timeline",
      "category": "Storytelling",
      "blocks": [
        { "type": "step" },
        { "type": "step" },
        { "type": "step" },
        { "type": "step" }
      ]
    }
  ]
}
{% endschema %}
